# geo-service
Разработан в соответствии с [Заданием](https://github.com/bugakov-sa/geo-service/blob/master/%D0%A2%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D0%BE%D0%B5%20%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20-%20%D0%B3%D0%B5%D0%BE%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81.pdf)

### Стек технологий, сборка и запуск
Проект разработан на стеке [Scala](https://www.scala-lang.org/) - [Akka-HTTP](http://doc.akka.io/docs/akka-http/current/scala.html) - [SBT](http://www.scala-sbt.org/)

Для сборки приложения из исходников необходимо в директории geo-service выполнить команду
```
sbt pack
```
Для сборки используется [sbt-pack plugin](https://github.com/xerial/sbt-pack)

После успешного выполнения этой команды, собранное приложение будет в папке geo-service/target/pack Эту папку можно скопировать в любое другое место. И запускать приложение с помощью скрипта из pack/bin

Структура директории pack:

1. Папка lib - в этой папке находятся jar-файл приложения и jar-файлы зависимостей.
2. Папка bin - в этой папке находятся скрипты запуска и файл с настройками приложения.
3. Папка data - в этой папке находятся таблицы с данными о метках пользователей и географической сетке.
4. Папка script - в этой папке находятс скрипты генерации файлов в папке data

В сборке уже есть сгенерированные данные в папке data. Вы можете заново сгенерировать метки пользователей и получить новый набор меток. Генерировать заново географическую сетку нет смысла - алгоритм неслучайный. Подробнее о содержимом папок script и data будет рассказано ниже.

###HTTP API
Реализовано в виде get-запросов. Рассмотрим пример каждого запроса.
#### Добавление и изменение метки пользователя
/users/update?id=1&lat=-45.8779978817&lon=33.5622549935
#### Удаление метки пользователя
/users/delete?id=1
#### Запрос метки пользователя
/users/select?id=1

Этого запроса нет в задании, он реализован для удобства тестирования.
#### Проверка, находится ли метка пользователя рядом с указанной в запросе точкой
/users/location?id=1&lat=-45.8779978817&lon=33.5622549935
#### Запрос числа пользователей в ячейке сетки, в которой находится указанная в запросе точка
/zones/count?lat=-45.8779978817&lon=33.5622549935

### Сложность выполнения запросов
Константная, О(1). В случае запросов /users/update, /users/delete, /users/select выполняется обращение к хеш-таблице пользователей. В случае запроса /users/location - обращение к хеш-таблице пользователей и обращение к хеш-таблице геозон. В случае запроса /zones/count - обращение к хеш-таблице cчетчиков пользователей.

Расчет числа пользователей count(z) в геозоне z реализован из следующего соображения:

count(z) в момент времени t = число входов пользователей в z в интервале времени [t0, t] - число выходов пользователей из z в интервале времени [t0, t], t0 - момент старта приложения

Каждый запрос update интерпретируется, либо как вход в зону (если это новый пользователь), либо как выход из одной зоны и вход в другую зону.

Каждый запрос delete интерпретируется, как выход из зоны (если указанный в запросе ИД пользователя существует).

Поскольку набор зон известен на момент старта приложения, можно на старте создать [scala.collection.immutable.HashMap](http://www.scala-lang.org/api/current/scala/collection/immutable/HashMap.html) с ключом (широта, долгота) и значением [AtomicLong](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicLong.html) и при каждом запросе update/delete изменять соответствующие счетчики.

### Алгоритмы генерации данных
Реализованы на python 2.7. [/script](https://github.com/bugakov-sa/geo-service/blob/master/script)

#### Генерация меток пользователей
Метка - пара чисел, широта и долгота. Самый простой способ генерации тестового набора меток - из равномерных распределений (от -180 градусов до +180 градусов для долготы и от -90 градусов до +90 градусов для широты). Недостаток такого способа - разная плотность меток в разных широтах, самая низкая - на экваторе, а самая высокая - на полюсах. То есть, при самом примитивном подходе, мы посредством равномерных распределений размечаем земной шар метками неравномерно. Неинтересно.

Будем генерировать метки так, чтобы они были равномерно распределены по земной поверхности. Долготу будем генерировать из равномерного распределения. Генерация широты посложнее.

Обозначим R - радиус земного шара, lat - широта в радианах (варьируется от -Pi/2 до +Pi/2). Разберем алгоритм генерации широты для точек северного полушария. В южном полушарии изменится лишь знак lat.

Длина параллели широты lat: L(lat) = 2 * Pi * R * sin(lat). 
     
Эта фукнция убывает от 2 * Pi * R на экваторе до 0 на северном полюсе. Эта фукнция определяет закон убывания вероятности появления метки на широте lat. 

Чтобы получить функцию плотности вероятности f(lat), L(lat) нужно нормировать, поделив на интеграл L(lat) на отрезке [0, Pi/2]. Обозначим этот интеграл I. 

Фукнция плотности вероятности генерации метки на широте lat: f(lat) = 2 * Pi * R * sin(lat) / I. 

Для генерации распределения с плотностью f, необходима обратная фукнция lat(f) = arcsin(I * f / (2 * Pi * R)). 

Диапазон изменения f - от 0 до f(0) = 2 * Pi * R / I. Обозначим r - равномерно распределенная случайная величина из отрезка от 0 до 1. 

Тогда алгоритм генерации широты метки в серверном полушарии: lat = arcsin(I * (r * 2 * Pi / I) / (2 * Pi * R)) = arcsin(r).

Алгоритм генерации меток пользователей реализован в двух вариантах:

1. [users.py](https://github.com/bugakov-sa/geo-service/blob/master/script/users.py) - генерация таблицы для геосервиса. Создает csv-файл [users.csv](https://github.com/bugakov-sa/geo-service/blob/master/data/users.csv) с колонками: ИД пользователя, широта, долгота.

2. [points.py](https://github.com/bugakov-sa/geo-service/blob/master/script/points.py) - генерация тестового набора точек для визуализации с помощью сервиса [mapcustomizer](https://www.mapcustomizer.com/). Создает csv-файл [ponts.csv](https://github.com/bugakov-sa/geo-service/blob/master/data/users.csv) с колонками: широта, долгота. Содержимое этого файла можно скопировать в форму Bulk Entry (в правом верхнем углу на странице [mapcustomizer](https://www.mapcustomizer.com/)) Так мы можем визуально оценить, насколько случайно точки разбросаны по земной поверхности. Поскольку земная поверхность спроецирована на прямоугольную карту, плотность точек на такой карте уменьшается при движении от экватора к полюсам.

#### Генерация географической сетки
Примитивный. В качестве опорных точек взяты точки с целочисленными координатами. Реализация алгоритма: [zones.py](https://github.com/bugakov-sa/geo-service/blob/master/script/zones.py). Результат работы алгоритма: [zones.csv](https://github.com/bugakov-sa/geo-service/blob/master/data/zones.csv)
